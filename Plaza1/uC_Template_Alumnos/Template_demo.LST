C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/29/2019 18:07:39 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE TEMPLATE_DEMO
OBJECT MODULE PLACED IN Template_demo.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Template_demo.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          
   2          #include <ADuC841.h>
   3          #include <stdio.h>
   4          #include <stdlib.h>
   5          #include <string.h>
   6          
   7          
   8          /**************** FPGA Communication Port: ********************/
   9          sbit TrigByte1N  = P0^7;                   
  10          sbit Ack1N       = P0^6;          
  11          sbit TrigByte2N  = P0^5;
  12          sbit Ack2N       = P0^4;
  13          sbit SelTrigger  = P0^3;
  14          sbit reset_fpga  = P0^0;
  15          /**************************************************************/
  16          int f=0;
  17          int q=0;
  18          int j =0; 
  19          unsigned char DATA_L;
  20          unsigned char DATA_H;
  21          unsigned int datain;
  22          
  23          unsigned char flagWait, RX_flag;
  24          unsigned char charWait;
  25          unsigned char flagInterrupt=0;
  26          
  27          unsigned char RX_Buffer[20];
  28          char aux[10];
  29          unsigned char flag, c;
  30          
  31          unsigned int result,Temp,Hum, LDR; 
  32          unsigned int estado=3, est_com=2; 
  33          
  34          unsigned int resulti[2];
  35                                                                             
  36          
  37          /***************** Timer Configuration: **************************/
  38          void _WS_Timer_Config(char value)//this function follows the frequency of the checking of the sensors
  39          {
  40   1              IEIP2   = 0xA4; // TIC Interruption enable
  41   1              SEC     = 0x00;
  42   1              HTHSEC  = 0x00;
  43   1              MIN             = 0x00;
  44   1              HOUR    = 0x00;
  45   1              INTVAL  = value;        //**(Config.)   
  46   1              TIMECON = 0x53;         // The timer interrupt each second **(Config.)  /* 0x43 = 1/128 seconds */
  47   1      }       
  48          /*****************************************************************/
  49          
  50          /***************** ADC Configuration: ****************************/
  51          void _WS_ADC_Config (void)         //it'll help us get information from the LDR
  52          {
  53   1              ADCCON1  = 0xAC;     // ADCCON1: ADC Configuration: 12 clock periods for each conversion.              
             -                                                       
  54   1              ADCCON2  = 0x03;     // Selects channel 3 & on demand conversion.  (LDR is connected to the ADC3)
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/29/2019 18:07:39 PAGE 2   

  55   1      }
  56          /*****************************************************************/
  57          
  58          /***************** UART configuration: ***************************/
  59          void _WSN_UART841_config()
  60          {
  61   1              SCON = 0x52;//SCON: UART Serial Port Control Register   => Mode 1: 8-bit UART, variable baud rate
  62   1              PCON = 0x80;//PCON: power-saving options and general-purpose status flags => SMOD=1 (Double UART Baud Rat
             -e)
  63   1              
  64   1              TMOD = 0x21;//Timer 1 Set M1 for 8-bit autoreload timer, Timer 0 Set M0 16-bit 
  65   1              TH1  = 0xDC;// 19200 ADuC841        //TH1 holds a value which is to be reloaded into TL1 each time it ove
             -rflows. (BaudRate = 19200 bps)
  66   1              TR1  = 1;   //Start timer 1
  67   1      
  68   1              TI  = 1;   //bit1(SCON): Serial Port Transmit Interrupt Flag.
  69   1              ES  = 1;        // Serial Port interruption enable
  70   1              ET1 = 0;        // Timer 1 Interruption Disable 
  71   1      
  72   1              EA  = 1;        // Global Enable Interruption Flag
  73   1      
  74   1              RX_flag = 0;
  75   1      }
  76          
  77          int _WSN_ADC_conversion()
  78          {
  79   1              unsigned int sensorData;
  80   1      
  81   1              //*** Sigle conversion:
  82   1              SCONV = 1;
  83   1              while (SCONV == 1);
  84   1      
  85   1              sensorData = ((ADCDATAH & 0x0F) * 0x0100) + ADCDATAL;
  86   1              
  87   1              SCONV = 0; // Conversion Flag
  88   1              
  89   1              return (sensorData);
  90   1      
  91   1      }
  92          /*****************************************************************/
  93          
  94          /****************** FPGA Initial config. *************************/
  95          void _WSN_ini_FPGA(void)
  96          { 
  97   1                 TrigByte1N  = 1;                
  98   1                 TrigByte2N  = 1;
  99   1                 SelTrigger  = 0;
 100   1                 reset_fpga  = 1;
 101   1      }
 102          /****************** FPGA-DATA capture: **************************/
 103          int _WSN_FPGA(bit sensorSelector)        //if we set this function at 0, we get 0 for the temp and one for the h
             -umidity value, which is a percentage
 104          {     
 105   1         unsigned int fpga_data;
 106   1               
 107   1         SelTrigger  = sensorSelector;
 108   1         TrigByte1N = 0; 
 109   1         while (Ack1N == 1){};
 110   1         
 111   1         DATA_L = P2;            // LSB
 112   1         TrigByte1N = 1;         // Release Trigger1
 113   1          
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/29/2019 18:07:39 PAGE 3   

 114   1         TrigByte2N = 0;         //Trigger second data byte
 115   1         while (Ack2N == 1){};
 116   1         
 117   1         DATA_H = P2;           // MSB
 118   1         TrigByte2N = 1;    // Release Trigger2
 119   1      
 120   1      
 121   1         fpga_data = DATA_L + 256*(int)DATA_H;
 122   1      
 123   1         return(fpga_data);  
 124   1         
 125   1      }
 126          /*****************************************************************/
 127          
 128           void _WSN_Write_UART(char *message)
 129          {  
 130   1        do{
 131   2              TI = 0;
 132   2              SBUF = *message++;
 133   2              while (!TI);
 134   2        }while(*message != '\0'); // wait untin null character is read from the TX message
 135   1          TI = 0;
 136   1      }                  
 137          
 138          /**************** Serial Reception: ******************************/
 139          void _WSN_Read_UART(char *message)
 140          {  
 141   1        do{
 142   2              RI = 0;
 143   2              while (!RI);
 144   2              *message++ = SBUF;      
 145   2        }while(SBUF != '\r');  // wait untin null character is read from the RX message
 146   1        *message = '\0'; // Ending writing a null character into the buffer
 147   1      }                                                                                                                                       
 148                             
 149          /***************** Serial Interruption: **************************/
 150            
 151          void _CEI_Serial_interrupt(void) interrupt 4 using 0
 152          {
 153   1              ES = 0; // Disable Serial Interruption
 154   1      
 155   1      
 156   1              if (RI == 1) {
 157   2                 
 158   2                 if(/*!flagWait && */SBUF == 'w'|| SBUF == 'W'){      // If we are not waiting for a particular character, t
             -his condition can be removed, so that every received byte will be stored in RX_Buffer 
 159   3                        _WSN_Read_UART(RX_Buffer);
 160   3                         RX_flag = 1;
 161   3                 }
 162   2                      else if(/*!flagWait && */SBUF == 'z'|| SBUF =='Z'){     // If we are not waiting for a particular character,
             - this condition can be removed, so that every received byte will be stored in RX_Buffer       
 163   3                        _WSN_Read_UART(RX_Buffer);
 164   3                        
 165   3                        RX_flag = 2;
 166   3                 }
 167   2                      else if(/*!flagWait && */SBUF == 't'|| SBUF =='T'){     // If we are not waiting for a particular charact
             -er, this condition can be removed, so that every received byte will be stored in RX_Buffer    
 168   3                
 169   3                        RX_flag = 3;
 170   3                 }
 171   2                      else if(/*!flagWait && */SBUF == 'f'|| SBUF =='F')
 172   2                      {
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/29/2019 18:07:39 PAGE 4   

 173   3                              RX_flag=4;      // If we are not waiting for a particular character, this condition can be removed, so that 
             -every received byte will be stored in RX_Buffer       
 174   3                      
 175   3                      }
 176   2      
 177   2                 else if(flagWait == 1 && SBUF == charWait){ // Condition for waiting an answer prompt, such as 'O' for
             - "OK", etc. 
 178   3                        flagWait = 0;
 179   3                 }
 180   2               RI=0;
 181   2              }//-------------------------------------
 182   1      
 183   1              ES = 1; // Esable Serial Interruption
 184   1      }
 185          
 186                                                                                                                                                  
 187          /***************** Timer Interruption: ***************************/
 188          void _WSN_interrupt_TimeInterval() interrupt 10 using 3    //this is the interruption of the timer. we jum
             -p into this function and we process a flag we're activating
 189          { 
 190   1         //unsigned int result,Temp,Hum,LDR,Axis;
 191   1      
 192   1            /** DO NOT EDIT *********/
 193   1                 c++;
 194   1                 if (c==2){
 195   2                   reset_fpga = 0;
 196   2                       reset_fpga = 1;
 197   2                       c = 0;
 198   2                 }   
 199   1                /************************/
 200   1         
 201   1         
 202   1         flag = 1;
 203   1      
 204   1            
 205   1      }
 206          /*****************************************************************/
 207          
 208          /*****************************************************************/
 209          
 210          /***************** Sensors reading functionalities: ***************/
 211          void _WSN_sensors_reading(void){                                 //we gotta read the humidity and the temperature 
 212   1      
 213   1         int result[2], i;
 214   1      
 215   1              Temp=_WSN_FPGA(0);
 216   1              Temp =  ( Temp - (273.15*100) );
 217   1              
 218   1              for(i=0;i<1000;i++);
 219   1      
 220   1      
 221   1              Hum=_WSN_FPGA(1);
 222   1              Hum =  ( (Hum*127.0)/100 );
 223   1      
 224   1      }
*** WARNING C280 IN LINE 213 OF TEMPLATE_DEMO.C: 'result': unreferenced local variable
 225          
 226          void _WSN_wait_answer(char ASCII,char getmsj)
 227          {  
 228   1              charWait = ASCII;       
 229   1              flagWait = 1;    
 230   1              while(flagWait);
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/29/2019 18:07:39 PAGE 5   

 231   1              flagWait = 1;
 232   1      }
*** WARNING C280 IN LINE 226 OF TEMPLATE_DEMO.C: 'getmsj': unreferenced local variable
 233          /**************** ZigBee Configuration: ************************/
 234          void _WSN_ZigBee_config(char type)
 235          {               
 236   1              _WSN_Write_UART("ATS00=0040\n\r\0");
 237   1              _WSN_wait_answer('O',0);
 238   1              _WSN_Write_UART("ATS02=0007\n\r\0");
 239   1              _WSN_wait_answer('O',0);
 240   1              _WSN_Write_UART("ATS03=1111111111111117\n\r\0");
 241   1              _WSN_wait_answer('O',0);
 242   1              _WSN_Write_UART("ATZ\n\r\0");
 243   1              _WSN_wait_answer('O',0);
 244   1              _WSN_Write_UART("AT+JN\n\r\0");
 245   1              _WSN_wait_answer('O',0);
 246   1      }
*** WARNING C280 IN LINE 234 OF TEMPLATE_DEMO.C: 'type': unreferenced local variable
 247          /******************* Message Detection: *************************/
 248          
 249          /******************* Main Function: *****************************/
 250          void imprimirestado()
 251          {
 252   1              if(estado==2)
 253   1              {
 254   2                      _WSN_Write_UART("AT+UCAST:0000=");
 255   2                      _WSN_Write_UART("Plaza 1: La plaza esta ocupada\n\r");
 256   2              }
 257   1              if(estado==3)
 258   1              {       
 259   2                      _WSN_Write_UART("AT+UCAST:0000=");
 260   2                      _WSN_Write_UART("Plaza 1: La plaza esta libre\n\r");
 261   2              }
 262   1      }
 263          
 264          void maquinaEstados()
 265          {
 266   1              // se inicializa como libre. estado 3 = libre, estado 2 = ocupado, estado 1 = recién ocupado
 267   1      
 268   1              if (estado == 3)
 269   1              {
 270   2                      if(LDR<1500)
 271   2                      {
 272   3                              estado=2;
 273   3                              RX_flag = 3;
 274   3                              f=1;
 275   3                      }
 276   2              }
 277   1              
 278   1              else if (estado == 2)
 279   1              {
 280   2                      if(LDR>=1500)
 281   2                      {
 282   3                              estado=3;
 283   3                              RX_flag = 3;            //El coche llega y se detecta aumento en temperatura por el motor.
 284   3                              f=2;
 285   3                      }
 286   2              }
 287   1      
 288   1      
 289   1      }
 290          
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/29/2019 18:07:39 PAGE 6   

 291          
 292          void EnviarDatos(void)
 293          {       
 294   1              if(RX_flag==1)
 295   1              {                        
 296   2                      est_com=1;
 297   2                      RX_flag=0;
 298   2                      j=0;
 299   2              }
 300   1              if(RX_flag==2)
 301   1              {
 302   2                      est_com=2;
 303   2                      RX_flag=0;
 304   2                      j=0;
 305   2              }
 306   1      
 307   1              if(est_com==1)
 308   1              {
 309   2                if (flag == 1)
 310   2                      {
 311   3                              //_WSN_sensors_reading();
 312   3                               
 313   3                              /********* SHT11 Sensor Layer *************************/
 314   3      
 315   3                              if(q<f)q++;
 316   3                              else
 317   3                              {
 318   4                              
 319   4                              LDR=_WSN_ADC_conversion();
 320   4                              maquinaEstados();
 321   4                              imprimirestado();       
 322   4                              q=0;
 323   4                              }
 324   3                              flag = 0;                       
 325   3                        }  
 326   2              }
 327   1              if (est_com==2)
 328   1              {  
 329   2                      
 330   2                      LDR=_WSN_ADC_conversion();
 331   2                      maquinaEstados();
 332   2                      flag = 0;
 333   2                      if(RX_flag==3)
 334   2                      {        
 335   3                              imprimirestado();               
 336   3                              RX_flag=0;
 337   3                      }
 338   2                      else if(RX_flag==4)
 339   2                      {                        
 340   3                              if(estado==3)
 341   3                              {
 342   4                                      _WSN_Write_UART("AT+UCAST:0000=");
 343   4                                      _WSN_Write_UART("Plaza 1 está libre\n\r");
 344   4                              }
 345   3                              RX_flag=0;
 346   3                      }
 347   2                      else if(RX_flag==5)
 348   2                      {       
 349   3                              if(estado==2)
 350   3                              {
 351   4                                      _WSN_Write_UART("AT+UCAST:0000=");
 352   4                                      _WSN_Write_UART("Plaza 1 está ocupada\n\r");
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/29/2019 18:07:39 PAGE 7   

 353   4                              }
 354   3                              RX_flag=0;
 355   3                      }
 356   2                      else
 357   2                      {
 358   3                              while(j<1)
 359   3                              {       
 360   4                                      
 361   4                                      _WSN_Write_UART("AT+UCAST:0000=");
 362   4                                      _WSN_Write_UART("Esperando llamada\n\r");
 363   4                                      j++;
 364   4                              }
 365   3                      }
 366   2              }
 367   1                              
 368   1      }
 369          
 370          
 371          
 372          void main()
 373          {        
 374   1      
 375   1      
 376   1               _WSN_UART841_config();
 377   1         //---- Peripheral Configurations: -------------
 378   1              _WSN_ini_FPGA();
 379   1              _WS_ADC_Config();
 380   1              _WSN_ZigBee_config();
*** WARNING C209 IN LINE 380 OF TEMPLATE_DEMO.C: '__WSN_ZigBee_config': too few actual parameters
 381   1              
 382   1         c = 'O';
 383   1         flag = 0;
 384   1      
 385   1         // --------------------------------------------
 386   1       
 387   1                      _WSN_Write_UART("Connected\n\r");
 388   1                      _WS_Timer_Config(1);                                                            
 389   1                      while (1)
 390   1                      {       
 391   2                                
 392   2                              EnviarDatos();          
 393   2                      }
 394   1      }
 395                  
 396          /****************************************************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1107    ----
   CONSTANT SIZE    =    225    ----
   XDATA SIZE       =     62      12
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  4 WARNING(S),  0 ERROR(S)
