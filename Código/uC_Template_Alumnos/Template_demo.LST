C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/16/2019 21:35:02 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE TEMPLATE_DEMO
OBJECT MODULE PLACED IN Template_demo.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Template_demo.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          
   2          #include <ADuC841.h>
   3          #include <stdio.h>
   4          
   5          /**************** FPGA Communication Port: ********************/
   6          sbit TrigByte1N  = P0^7;                   
   7          sbit Ack1N       = P0^6;          
   8          sbit TrigByte2N  = P0^5;
   9          sbit Ack2N       = P0^4;
  10          sbit SelTrigger  = P0^3;
  11          sbit reset_fpga  = P0^0;
  12          /**************************************************************/
  13          
  14          unsigned char DATA_L;
  15          unsigned char DATA_H;
  16          unsigned int datain;
  17          
  18          unsigned char flag, c;
  19          
  20          unsigned int result,Temp,Hum, LDR, estado=3; 
  21          //unsigned char configvalue=1;
  22          unsigned int resulti[2];
  23                                                                             
  24          
  25          /***************** Timer Configuration: **************************/
  26          void _WS_Timer_Config(char value)//this function follows the frequency of the checking of the sensors
  27          {
  28   1              IEIP2   = 0xA4; // TIC Interruption enable
  29   1              SEC     = 0x00;
  30   1              HTHSEC  = 0x00;
  31   1              MIN             = 0x00;
  32   1              HOUR    = 0x00;
  33   1              INTVAL  = value;        //**(Config.)   
  34   1              TIMECON = 0x53;         // The timer interrupt each second **(Config.)  /* 0x43 = 1/128 seconds */
  35   1      }       
  36          /*****************************************************************/
  37          
  38          /***************** ADC Configuration: ****************************/
  39          void _WS_ADC_Config (void)         //it'll help us get information from the LDR
  40          {
  41   1              ADCCON1  = 0xAC;     // ADCCON1: ADC Configuration: 12 clock periods for each conversion.              
             -                                                       
  42   1              ADCCON2  = 0x03;     // Selects channel 3 & on demand conversion.  (LDR is connected to the ADC3)
  43   1      }
  44          /*****************************************************************/
  45          
  46          /***************** UART configuration: ***************************/
  47          void _WSN_UART841_config()
  48          {
  49   1              SCON = 0x52;//SCON: UART Serial Port Control Register   => Mode 1: 8-bit UART, variable baud rate
  50   1              PCON = 0x80;//PCON: power-saving options and general-purpose status flags => SMOD=1 (Double UART Baud Rat
             -e)
  51   1              
  52   1              TMOD = 0x21;//Timer 1 Set M1 for 8-bit autoreload timer, Timer 0 Set M0 16-bit 
  53   1              TH1  = 0xDC;// 19200 ADuC841        //TH1 holds a value which is to be reloaded into TL1 each time it ove
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/16/2019 21:35:02 PAGE 2   

             -rflows. (BaudRate = 19200 bps)
  54   1              TR1  = 1;   //Start timer 1
  55   1      
  56   1              TI  = 1;   //bit1(SCON): Serial Port Transmit Interrupt Flag.
  57   1              ES  = 0;        // Serial Port interruption disable
  58   1              ET1 = 0;        // Timer 1 Interruption Disable 
  59   1      
  60   1              EA  = 1;        // Global Enable Interruption Flag
  61   1      }
  62          /****************************************************************/
  63          
  64          /****************** ADC Conversion: *****************************/
  65          int _WSN_ADC_conversion()
  66          {
  67   1              unsigned int sensorData;
  68   1      
  69   1              //*** Sigle conversion:
  70   1              SCONV = 1;
  71   1              while (SCONV == 1);
  72   1      
  73   1              sensorData = ((ADCDATAH & 0x0F) * 0x0100) + ADCDATAL;
  74   1              
  75   1              SCONV = 0; // Conversion Flag
  76   1              
  77   1              return (sensorData);
  78   1      
  79   1      }
  80          /*****************************************************************/
  81          
  82          /****************** FPGA Initial config. *************************/
  83          void _WSN_ini_FPGA(void)
  84          { 
  85   1                 TrigByte1N  = 1;                
  86   1                 TrigByte2N  = 1;
  87   1                 SelTrigger  = 0;
  88   1                 reset_fpga  = 1;
  89   1      }
  90          /****************** FPGA-DATA capture: **************************/
  91          int _WSN_FPGA(bit sensorSelector)        //if we set this function at 0, we get 0 for the temp and one for the h
             -umidity value, which is a percentage
  92          {     
  93   1         unsigned int fpga_data;
  94   1               
  95   1         SelTrigger  = sensorSelector;
  96   1         TrigByte1N = 0; 
  97   1         while (Ack1N == 1){};
  98   1         
  99   1         DATA_L = P2;            // LSB
 100   1         TrigByte1N = 1;         // Release Trigger1
 101   1          
 102   1         TrigByte2N = 0;         //Trigger second data byte
 103   1         while (Ack2N == 1){};
 104   1         
 105   1         DATA_H = P2;           // MSB
 106   1         TrigByte2N = 1;    // Release Trigger2
 107   1      
 108   1      
 109   1         fpga_data = DATA_L + 256*(int)DATA_H;
 110   1      
 111   1         return(fpga_data);  
 112   1         
 113   1      }
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/16/2019 21:35:02 PAGE 3   

 114          /*****************************************************************/
 115                                                                                                                                                  
 116          /***************** Timer Interruption: ***************************/
 117          void _WSN_interrupt_TimeInterval() interrupt 10 using 3    //this is the interruption of the timer. we jum
             -p into this function and we process a flag we're activating
 118          { 
 119   1         //unsigned int result,Temp,Hum,LDR,Axis;
 120   1      
 121   1            /** DO NOT EDIT *********/
 122   1                 c++;
 123   1                 if (c==2){
 124   2                   reset_fpga = 0;
 125   2                       reset_fpga = 1;
 126   2                       c = 0;
 127   2                 }   
 128   1                /************************/
 129   1         
 130   1         
 131   1         flag = 1;
 132   1      
 133   1            
 134   1      }
 135          /*****************************************************************/
 136          
 137          /***************** Sensors reading functionalities: ***************/
 138          void _WSN_sensors_reading(void){                                 //we gotta read the humidity and the temperature 
 139   1      
 140   1         int result[2], i;
 141   1      
 142   1              //_WSN_FPGA(0) = Temperature, ACC Y;
 143   1              Temp=_WSN_FPGA(0);
 144   1              Temp =  ( Temp - (273.15*100) );
 145   1              for(i=0;i<100;i++);
 146   1      
 147   1              //_WSN_FPGA(1) = Humidity, ACC X;
 148   1              Hum=_WSN_FPGA(1);
 149   1              Hum =  ( (Hum*127.0)/100 );
 150   1      
 151   1         /************ Temp: ******************/
 152   1         //resulti[0]=result[0]*100/27315;
 153   1         // the temperature value taken from the FPGA has     to be
 154   1         // substracted from 27315 in order to show Degree Celsius x 100                              
 155   1         // Ej: Temp =  ( result - (273.15*100) );      // Degree Celsius x 100
 156   1         // c = 0;
 157   1         /*************************************/
 158   1      
 159   1         /************ Humidity ***************/
 160   1         //resulti[1] = result[1]*127.5/100;
 161   1         // the humidity value taken form the FPGA has to be multipled
 162   1         // by 127.5 and divided by 100 in order to show H% x 100.
 163   1         // Ej: Hum =  ( (result*127.0)/100 );
 164   1         // c = 0;
 165   1         /*************************************/
 166   1         
 167   1         /************ Light: ******************/
 168   1      
 169   1         /**************************************/     
 170   1      
 171   1      
 172   1      }
*** WARNING C280 IN LINE 140 OF TEMPLATE_DEMO.C: 'result': unreferenced local variable
 173          /*****************************************************************/
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/16/2019 21:35:02 PAGE 4   

 174          
 175          /****************** ZigBee read: *********************************/
 176          /** ASCII  = Value of the character to wait.
 177          /** getsmj = It allows to get caracters from the serial port and 
 178          /** print them until ASCII arrives. 
 179          **/
 180          
 181          void _WSN_wait_answer(char ASCII,char getmsj)
 182          {  
 183   1              unsigned char serial_read,enable;
 184   1      
 185   1              enable = 1;
 186   1        
 187   1                   do
 188   1                      {
 189   2                              serial_read = _getkey(); 
 190   2              
 191   2                              if (serial_read == ASCII) 
 192   2                              {                                                                                        
 193   3                                      enable = 0;
 194   3                              }
 195   2                              else if (getmsj == 1)
 196   2                              {
 197   3                                      putchar(serial_read);
 198   3                              }                       
 199   2                      }while (enable != 0);
 200   1      }
 201          /**************** ZigBee Configuration: ************************/
 202          void _WSN_ZigBee_config(char type)
 203          { 
 204   1      
 205   1      
 206   1      } 
*** WARNING C280 IN LINE 202 OF TEMPLATE_DEMO.C: 'type': unreferenced local variable
 207          /******************* Message Detection: *************************/
 208          void _WSN_message_detect()
 209          {  
 210   1              _WSN_wait_answer('U',0);
 211   1              _WSN_wait_answer(':',0);
 212   1              _WSN_wait_answer(',',1);
 213   1               putchar('\t');
 214   1              _WSN_wait_answer('=',0);
 215   1              _WSN_wait_answer(0x03,1); 
 216   1      }
 217          /******************* Main Function: *****************************/
 218          void maquinaEstados()
 219          {
 220   1              // se inicializa como libre. estado 3 = libre, estado 2 = ocupado, estado 1 = recién ocupado
 221   1              if (LDR <1000 & Temp > 25 & estado == 3)
 222   1              {
 223   2                      estado=1;               //El coche llega y se detecta aumento en temperatura por el motor.
 224   2              }
 225   1              else if(LDR < 1000 & Temp <= 25 & estado == 1)
 226   1              {
 227   2                      estado=2;         //el coche se enfría pero sigue ocupando la plaza
 228   2              }
 229   1              else if(LDR >=1000 & estado == 2)
 230   1              {
 231   2                      estado=3;        //se va el coche del parking
 232   2              }
 233   1      }
 234          
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/16/2019 21:35:02 PAGE 5   

 235          void imprimirestado()
 236          {
 237   1              if(estado==1)
 238   1              {
 239   2                      printf("Nodo 1: La plaza acaba de ocuparse");
 240   2              }
 241   1              if(estado==2)
 242   1              {
 243   2                      printf("Nodo 1: La plaza estaba ocupada");
 244   2              }
 245   1              if(estado==3)
 246   1              {
 247   2                      printf("Nodo 1: La plaza esta libre");
 248   2              }
 249   1      }
 250          void main()
 251          {
 252   1        
 253   1         //---- Peripheral Configurations: -------------
 254   1              _WSN_ini_FPGA();
 255   1              _WS_ADC_Config();
 256   1              _WSN_UART841_config();
 257   1              
 258   1         c = 0;
 259   1         flag = 0;
 260   1      
 261   1         // --------------------------------------------
 262   1      
 263   1                 printf ("Connected\n\r");                               
 264   1      
 265   1                 while (1)
 266   1                 {
 267   2                              
 268   2                         _WS_Timer_Config(1);
 269   2                         if (flag == 1){
 270   3      
 271   3                              _WSN_sensors_reading();
 272   3                               maquinaEstados();
 273   3                              /********* SHT11 Sensor Layer *************************/
 274   3                              printf("Temperatura = %d\n",Temp);
 275   3                              printf("Humedad = %d\n",Hum);
 276   3                              LDR=_WSN_ADC_conversion();
 277   3                              printf("LDR = %d\n", LDR);
 278   3      
 279   3                              imprimirestado();
 280   3                         /*******************************************************/
 281   3                              
 282   3                              /********* ACC Sensor layer **************************
 283   3      
 284   3                              /*****************************************************/                 
 285   3      
 286   3                              flag = 0;
 287   3      
 288   3                      }                               
 289   2                                                
 290   2                 }
 291   1      
 292   1      }
 293          /****************************************************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/16/2019 21:35:02 PAGE 6   

   CODE SIZE        =    629    ----
   CONSTANT SIZE    =    149    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     20       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
