C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/20/2019 20:39:12 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE TEMPLATE_DEMO
OBJECT MODULE PLACED IN Template_demo.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Template_demo.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          
   2          #include <ADuC841.h>
   3          #include <stdio.h>
   4          
   5          
   6          /**************** FPGA Communication Port: ********************/
   7          sbit TrigByte1N  = P0^7;                   
   8          sbit Ack1N       = P0^6;          
   9          sbit TrigByte2N  = P0^5;
  10          sbit Ack2N       = P0^4;
  11          sbit SelTrigger  = P0^3;
  12          sbit reset_fpga  = P0^0;
  13          /**************************************************************/
  14          
  15          unsigned char DATA_L;
  16          unsigned char DATA_H;
  17          unsigned int datain;
  18          
  19          unsigned char flag, c;
  20          
  21          unsigned int result,Temp,Hum, LDR; 
  22          unsigned int estado=3, est_com = 1; 
  23          //unsigned char configvalue=1;
  24          unsigned int resulti[2];
  25                                                                             
  26          
  27          /***************** Timer Configuration: **************************/
  28          void _WS_Timer_Config(char value)//this function follows the frequency of the checking of the sensors
  29          {
  30   1              IEIP2   = 0xA4; // TIC Interruption enable
  31   1              SEC     = 0x00;
  32   1              HTHSEC  = 0x00;
  33   1              MIN             = 0x00;
  34   1              HOUR    = 0x00;
  35   1              INTVAL  = value;        //**(Config.)   
  36   1              TIMECON = 0x53;         // The timer interrupt each second **(Config.)  /* 0x43 = 1/128 seconds */
  37   1      }       
  38          /*****************************************************************/
  39          
  40          /***************** ADC Configuration: ****************************/
  41          void _WS_ADC_Config (void)         //it'll help us get information from the LDR
  42          {
  43   1              ADCCON1  = 0xAC;     // ADCCON1: ADC Configuration: 12 clock periods for each conversion.              
             -                                                       
  44   1              ADCCON2  = 0x03;     // Selects channel 3 & on demand conversion.  (LDR is connected to the ADC3)
  45   1      }
  46          /*****************************************************************/
  47          
  48          /***************** UART configuration: ***************************/
  49          void _WSN_UART841_config()
  50          {
  51   1              SCON = 0x52;//SCON: UART Serial Port Control Register   => Mode 1: 8-bit UART, variable baud rate
  52   1              PCON = 0x80;//PCON: power-saving options and general-purpose status flags => SMOD=1 (Double UART Baud Rat
             -e)
  53   1              
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/20/2019 20:39:12 PAGE 2   

  54   1              TMOD = 0x21;//Timer 1 Set M1 for 8-bit autoreload timer, Timer 0 Set M0 16-bit 
  55   1              TH1  = 0xDC;// 19200 ADuC841        //TH1 holds a value which is to be reloaded into TL1 each time it ove
             -rflows. (BaudRate = 19200 bps)
  56   1              TR1  = 1;   //Start timer 1
  57   1      
  58   1              TI  = 1;   //bit1(SCON): Serial Port Transmit Interrupt Flag.
  59   1              ES  = 0;        // Serial Port interruption disable
  60   1              ET1 = 0;        // Timer 1 Interruption Disable 
  61   1      
  62   1              EA  = 1;        // Global Enable Interruption Flag
  63   1      }
  64          /****************************************************************/
  65          
  66          /****************** ADC Conversion: *****************************/
  67          int _WSN_ADC_conversion()
  68          {
  69   1              unsigned int sensorData;
  70   1      
  71   1              //*** Sigle conversion:
  72   1              SCONV = 1;
  73   1              while (SCONV == 1);
  74   1      
  75   1              sensorData = ((ADCDATAH & 0x0F) * 0x0100) + ADCDATAL;
  76   1              
  77   1              SCONV = 0; // Conversion Flag
  78   1              
  79   1              return (sensorData);
  80   1      
  81   1      }
  82          /*****************************************************************/
  83          
  84          /****************** FPGA Initial config. *************************/
  85          void _WSN_ini_FPGA(void)
  86          { 
  87   1                 TrigByte1N  = 1;                
  88   1                 TrigByte2N  = 1;
  89   1                 SelTrigger  = 0;
  90   1                 reset_fpga  = 1;
  91   1      }
  92          /****************** FPGA-DATA capture: **************************/
  93          int _WSN_FPGA(bit sensorSelector)        //if we set this function at 0, we get 0 for the temp and one for the h
             -umidity value, which is a percentage
  94          {     
  95   1         unsigned int fpga_data;
  96   1               
  97   1         SelTrigger  = sensorSelector;
  98   1         TrigByte1N = 0; 
  99   1         while (Ack1N == 1){};
 100   1         
 101   1         DATA_L = P2;            // LSB
 102   1         TrigByte1N = 1;         // Release Trigger1
 103   1          
 104   1         TrigByte2N = 0;         //Trigger second data byte
 105   1         while (Ack2N == 1){};
 106   1         
 107   1         DATA_H = P2;           // MSB
 108   1         TrigByte2N = 1;    // Release Trigger2
 109   1      
 110   1      
 111   1         fpga_data = DATA_L + 256*(int)DATA_H;
 112   1      
 113   1         return(fpga_data);  
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/20/2019 20:39:12 PAGE 3   

 114   1         
 115   1      }
 116          /*****************************************************************/
 117                                                                                                                                                  
 118          /***************** Timer Interruption: ***************************/
 119          void _WSN_interrupt_TimeInterval() interrupt 10 using 3    //this is the interruption of the timer. we jum
             -p into this function and we process a flag we're activating
 120          { 
 121   1         //unsigned int result,Temp,Hum,LDR,Axis;
 122   1      
 123   1            /** DO NOT EDIT *********/
 124   1                 c++;
 125   1                 if (c==2){
 126   2                   reset_fpga = 0;
 127   2                       reset_fpga = 1;
 128   2                       c = 0;
 129   2                 }   
 130   1                /************************/
 131   1         
 132   1         
 133   1         flag = 1;
 134   1      
 135   1            
 136   1      }
 137          /*****************************************************************/
 138          
 139          /***************** Sensors reading functionalities: ***************/
 140          void _WSN_sensors_reading(void){                                 //we gotta read the humidity and the temperature 
 141   1      
 142   1         int result[2], i;
 143   1      
 144   1              //_WSN_FPGA(0) = Temperature, ACC Y;
 145   1              Temp=_WSN_FPGA(0);
 146   1              Temp =  ( Temp - (273.15*100) );
 147   1              for(i=0;i<100;i++);
 148   1      
 149   1              //_WSN_FPGA(1) = Humidity, ACC X;
 150   1              Hum=_WSN_FPGA(1);
 151   1              Hum =  ( (Hum*127.0)/100 );
 152   1      
 153   1         /************ Temp: ******************/
 154   1         //resulti[0]=result[0]*100/27315;
 155   1         // the temperature value taken from the FPGA has     to be
 156   1         // substracted from 27315 in order to show Degree Celsius x 100                              
 157   1         // Ej: Temp =  ( result - (273.15*100) );      // Degree Celsius x 100
 158   1         // c = 0;
 159   1         /*************************************/
 160   1      
 161   1         /************ Humidity ***************/
 162   1         //resulti[1] = result[1]*127.5/100;
 163   1         // the humidity value taken form the FPGA has to be multipled
 164   1         // by 127.5 and divided by 100 in order to show H% x 100.
 165   1         // Ej: Hum =  ( (result*127.0)/100 );
 166   1         // c = 0;
 167   1         /*************************************/
 168   1         
 169   1         /************ Light: ******************/
 170   1      
 171   1         /**************************************/     
 172   1      
 173   1      
 174   1      }
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/20/2019 20:39:12 PAGE 4   

*** WARNING C280 IN LINE 142 OF TEMPLATE_DEMO.C: 'result': unreferenced local variable
 175          /*****************************************************************/
 176          
 177          /****************** ZigBee read: *********************************/
 178          /** ASCII  = Value of the character to wait.
 179          /** getsmj = It allows to get caracters from the serial port and 
 180          /** print them until ASCII arrives. 
 181          **/
 182          
 183          void _WSN_wait_answer(char ASCII,char getmsj)
 184          {  
 185   1              unsigned char serial_read,enable;
 186   1      
 187   1              enable = 1;
 188   1        
 189   1                   do
 190   1                      {
 191   2                              serial_read = _getkey(); 
 192   2              
 193   2                              if (serial_read == ASCII) 
 194   2                              {                                                                                        
 195   3                                      enable = 0;
 196   3                              }
 197   2                              else if (getmsj == 1)
 198   2                              {
 199   3                                      putchar(serial_read);
 200   3                              }                       
 201   2                      }while (enable != 0);
 202   1      }
 203          /**************** ZigBee Configuration: ************************/
 204          void _WSN_ZigBee_config(char type)
 205          { 
 206   1      
 207   1      
 208   1      } 
*** WARNING C280 IN LINE 204 OF TEMPLATE_DEMO.C: 'type': unreferenced local variable
 209          /******************* Message Detection: *************************/
 210          void _WSN_message_detect()
 211          {  
 212   1              _WSN_wait_answer('U',0);
 213   1              _WSN_wait_answer(':',0);
 214   1              _WSN_wait_answer(',',1);
 215   1               putchar('\t');
 216   1              _WSN_wait_answer('=',0);
 217   1              _WSN_wait_answer(0x03,1); 
 218   1      }
 219          /******************* Main Function: *****************************/
 220          void maquinaEstados()
 221          {
 222   1              // se inicializa como libre. estado 3 = libre, estado 2 = ocupado, estado 1 = recién ocupado
 223   1              if (LDR <1000 & Temp > 25 & estado == 3)
 224   1              {
 225   2                      estado=1;               //El coche llega y se detecta aumento en temperatura por el motor.
 226   2              }
 227   1              else if(LDR < 1000 & Temp <= 25 & estado == 1)
 228   1              {
 229   2                      estado=2;         //el coche se enfría pero sigue ocupando la plaza
 230   2              }
 231   1              else if(LDR >=1000 & estado == 2)
 232   1              {
 233   2                      estado=3;        //se va el coche del parking
 234   2              }
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/20/2019 20:39:12 PAGE 5   

 235   1      }
 236          
 237          void imprimirestado()
 238          {
 239   1              if(estado==1)
 240   1              {
 241   2                      printf("Nodo 1: La plaza acaba de ocuparse");
 242   2              }
 243   1              if(estado==2)
 244   1              {
 245   2                      printf("Nodo 1: La plaza estaba ocupada");
 246   2              }
 247   1              if(estado==3)
 248   1              {
 249   2                      printf("Nodo 1: La plaza esta libre");
 250   2              }
 251   1      }
 252          
 253          void MEST_Comunicaciones()
 254          {
 255   1              //est_com se inicializa a 1, 1 es el modo de enviar la información cada x tiempo y 2 se envía la informac
             -ión cuando se le pida 
 256   1      }
 257          
 258          void Comunicaciones()
 259          {
 260   1              if(est_com == 1)
 261   1              {
 262   2                      while (1)
 263   2                 {
 264   3                              
 265   3                         _WS_Timer_Config(1);
 266   3                         if (flag == 1)
 267   3                         {
 268   4                              _WSN_sensors_reading();
 269   4                               maquinaEstados();
 270   4                              /********* SHT11 Sensor Layer *************************/
 271   4                              printf("Temperatura = %d\n",Temp);
 272   4                              printf("Humedad = %d\n",Hum);
 273   4                              LDR=_WSN_ADC_conversion();
 274   4                              printf("LDR = %d\n", LDR);
 275   4      
 276   4                              imprimirestado();
 277   4                              
 278   4                         /*******************************************************/
 279   4                              
 280   4                              /********* ACC Sensor layer **************************
 281   4      
 282   4                              /*****************************************************/                 
 283   4      
 284   4                              flag = 0;
 285   4                              }
 286   3                      }
 287   2              }
 288   1              if(est_com == 2)
 289   1              {
 290   2               if (flag == 1)
 291   2                      {
 292   3                              _WSN_sensors_reading();
 293   3                               maquinaEstados();
 294   3                              /********* SHT11 Sensor Layer *************************/
 295   3                              printf("Temperatura = %d\n",Temp);
C51 COMPILER V8.08   TEMPLATE_DEMO                                                         01/20/2019 20:39:12 PAGE 6   

 296   3                              printf("Humedad = %d\n",Hum);
 297   3                              LDR=_WSN_ADC_conversion();
 298   3                              printf("LDR = %d\n", LDR);
 299   3      
 300   3                              imprimirestado();
 301   3                              
 302   3                         /*******************************************************/
 303   3                              
 304   3                              /********* ACC Sensor layer **************************
 305   3      
 306   3                              /*****************************************************/                 
 307   3      
 308   3                              flag = 0;
 309   3                              }
 310   2                      }
 311   1      
 312   1      }
 313          void main()
 314          {
 315   1        
 316   1         //---- Peripheral Configurations: -------------
 317   1              _WSN_ini_FPGA();
 318   1              _WS_ADC_Config();
 319   1              _WSN_UART841_config();
 320   1              
 321   1         c = 0;
 322   1         flag = 0;
 323   1      
 324   1         // --------------------------------------------
 325   1      
 326   1                 printf ("Connected\n\r");                                                            
 327   1                 Comunicaciones();                      
 328   1                 
 329   1      
 330   1      }
 331          /****************************************************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    720    ----
   CONSTANT SIZE    =    149    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     22       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
